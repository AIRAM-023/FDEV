<html>

<head>
	<meta charset="utf-8">
	<title>VSCode Tests</title>
	<link href="../../../node_modules/mocha/mocha.css" rel="stylesheet" />
</head>

<body>
	<div id="mocha"></div>
	<script src="../../../node_modules/mocha/mocha.js"></script>
	<script type="importmap">
		{
			"imports": {
				"@parcel/watcher": "./import-map/parcel-watcher.js",
				"@vscode/ripgrep": "./import-map/vscode-ripgrep.js",
				"@vscode/sqlite3": "./import-map/vscode-sqlite3.js",
				"@vscode/windows-ca-certs": "./import-map/vscode-windows-ca-certs.js",
				"@vscode/windows-process-tree": "./import-map/vscode-windows-process-tree.js",
				"@vscode/windows-registry": "./import-map/vscode-windows-registry.js",
				"@xterm/addon-canvas": "./import-map/xterm-addon-canvas.js",
				"@xterm/headless": "./import-map/xterm-headless.js",
				"@xterm/xterm": "./import-map/xterm.js",
				"assert": "./import-map/assert.js",
				"child_process": "./import-map/child_process.js",
				"cookie": "./import-map/cookie.js",
				"crypto": "./import-map/crypto.js",
				"electron": "./import-map/electron.js",
				"events": "./import-map/events.js",
				"fs": "./import-map/fs.js",
				"graceful-fs": "./import-map/graceful-fs.js",
				"istanbul-lib-coverage": "./import-map/istanbul-lib-coverage.js",
				"istanbul-lib-instrument": "./import-map/istanbul-lib-instrument.js",
				"istanbul-lib-report": "./import-map/istanbul-lib-report.js",
				"istanbul-lib-source-maps": "./import-map/istanbul-lib-source-maps.js",
				"istanbul-reports": "./import-map/istanbul-reports.js",
				"jschardet": "./import-map/jschardet.js",
				"kerberos": "./import-map/kerberos.js",
				"minimatch": "./import-map/minimatch.js",
				"minimist": "./import-map/minimist.js",
				"mocha": "./import-map/mocha.js",
				"native-is-elevated": "./import-map/native-is-elevated.js",
				"native-keymap": "./import-map/native-keymap.js",
				"native-watchdog": "./import-map/native-watchdog.js",
				"net": "./import-map/net.js",
				"node:os": "./import-map/os.js",
				"node:path": "./import-map/path.js",
				"os": "./import-map/os.js",
				"path": "./import-map/path.js",
				"sinon-test": "./import-map/sinon-test.js",
				"sinon": "./import-map/sinon.js",
				"stream": "./import-map/stream.js",
				"string_decoder": "./import-map/string_decoder.js",
				"url": "./import-map/url.js",
				"util": "./import-map/util.js",
				"vscode-regexpp": "./import-map/vscode-regexpp.js",
				"windows-foreground-love": "./import-map/windows-foreground-love.js",
				"yauzl": "./import-map/yauzl.js",
				"zlib": "./import-map/zlib.js"
			}
		}
	</script>

	<script>

		// !!! DO NOT CHANGE !!!
		// Our unit tests may run in environments without
		// display (e.g. from builds) and tests may by
		// accident bring up native dialogs or even open
		// windows. This we cannot allow as it may crash
		// the test run.
		// !!! DO NOT CHANGE !!!
		window.open = function () { throw new Error('window.open() is not supported in tests!'); };
		window.alert = function () { throw new Error('window.alert() is not supported in tests!'); }
		window.confirm = function () { throw new Error('window.confirm() is not supported in tests!'); }

		// Ignore uncaught cancelled promise errors
		window.addEventListener('unhandledrejection', e => {
			const name = e && e.reason && e.reason.name;

			if (name === 'Canceled') {
				e.preventDefault();
				e.stopPropagation();
			}
		});

		mocha.setup({
			ui: 'tdd',
			timeout: typeof process.env['BUILD_ARTIFACTSTAGINGDIRECTORY'] === 'string' ? 30000 : 5000,
			forbidOnly: typeof process.env['BUILD_ARTIFACTSTAGINGDIRECTORY'] === 'string' // disallow .only() when running on build machine
		});
	</script>
	<script>
		const urlParams = new URLSearchParams(window.location.search);
		const argv = JSON.parse(urlParams.get('argv'));

		const outdir = argv.build ? 'out-build' : 'out';
		const basePath = require('path').join(__dirname, `../../../${outdir}/`);
		const baseUrl = require('url').pathToFileURL(basePath);

		// Tests run in a renderer that IS node-enabled. Wo we will encounter imports for node-modules which isn't
		// supported by blink/chromium. To work around this, we generate an import map that maps all node modules
		// to a blob that exports all properties of the module as named exports and the module itself as default.

		function asRequireBlobUri(name) {
			let _mod;
			try {
				_mod = require(name);

			} catch (err) {
				// These are somewhat expected because of platform differences (windows vs mac vs linux) or because of node/electron binary differences
				// console.error(`[ESM] Failed to require ${name}`);
				// console.error(err);
				return undefined;
			}

			// export all properties and the module itself as default
			let jsSrc = `const _mod = require('${name}')\n`;
			for (const name of Object.keys(_mod)) {
				jsSrc += `export const ${name} = _mod['${name}'];\n`;
			}
			jsSrc += `export default _mod;\n`;

			const blob = new Blob([jsSrc], { type: 'application/javascript' });
			const url = URL.createObjectURL(blob);
			return url;
		}

		// generate import map
		const importMap = {
			imports: {
				assert: new URL('../test/unit/assert-esm.js', baseUrl).href,
				sinon: new URL('../node_modules/sinon/pkg/sinon-esm.js', baseUrl).href,
				'sinon-test': new URL('../node_modules/sinon-test/dist/sinon-test-es.js', baseUrl).href,
				'electron': asRequireBlobUri('electron'),
			}
		};

		const builtin = require('module').builtinModules.filter(mod => !mod.startsWith('_') && !mod.startsWith('electron/js2c/')).sort();
		const dependencies = Object.keys(require('../../../package.json').dependencies).sort();
		const optionalDependencies = Object.keys(require('../../../package.json').optionalDependencies).sort();
		const dependenciesRemote = Object.keys(require('../../../remote/package.json').dependencies).sort();

		for (const name of new Set([].concat(builtin, dependencies, optionalDependencies, dependenciesRemote))) {
			const url = asRequireBlobUri(name);
			if(!url) {
				continue;
			}

			importMap.imports[name] = url;
		}

		//2: CSS modules
		const style = document.createElement('style');
		style.type = 'text/css';
		document.head.appendChild(style);

		globalThis._VSCODE_CSS_LOAD = function (url) {
			style.sheet.insertRule(`@import url(${url});`);
		};

		const { promisify } = require('util');
		globalThis._VSCODE_TEST_INIT = promisify(require('glob'))('**/*.css', { cwd: basePath }).then(cssModules => {
			for (const cssModule of cssModules) {
				const cssUrl = new URL(cssModule, baseUrl).href;
				const jsSrc = `globalThis._VSCODE_CSS_LOAD('${cssUrl}');\n`;
				const blob = new Blob([jsSrc], { type: 'application/javascript' });
				importMap.imports[cssUrl] = URL.createObjectURL(blob);
			}

		}).then(() => {
			const rawImportMap = JSON.stringify(importMap, undefined, 2);
			const importMapScript = document.createElement('script');
			importMapScript.type = 'importmap';
			importMapScript.textContent = rawImportMap;
			document.head.append(importMapScript);
		});
	</script>
	<script src="./renderer.js"></script>
</body>

</html>
