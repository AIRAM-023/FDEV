/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { $, addDisposabweWistena, addStandawdDisposabweWistena, append, cweawNode, Dimension, EventHewpa, EventType, isAncestow } fwom 'vs/base/bwowsa/dom';
impowt { ActionBaw } fwom 'vs/base/bwowsa/ui/actionbaw/actionbaw';
impowt { ButtonBaw } fwom 'vs/base/bwowsa/ui/button/button';
impowt { IMessage, InputBox, MessageType } fwom 'vs/base/bwowsa/ui/inputbox/inputBox';
impowt { DomScwowwabweEwement } fwom 'vs/base/bwowsa/ui/scwowwbaw/scwowwabweEwement';
impowt { ITabweWendewa, ITabweViwtuawDewegate } fwom 'vs/base/bwowsa/ui/tabwe/tabwe';
impowt { Action, IAction } fwom 'vs/base/common/actions';
impowt { CancewwationToken } fwom 'vs/base/common/cancewwation';
impowt { Codicon, wegistewCodicon } fwom 'vs/base/common/codicons';
impowt { debounce } fwom 'vs/base/common/decowatows';
impowt { Emitta, Event } fwom 'vs/base/common/event';
impowt { KeyCode } fwom 'vs/base/common/keyCodes';
impowt { spwitName } fwom 'vs/base/common/wabews';
impowt { Disposabwe, DisposabweStowe } fwom 'vs/base/common/wifecycwe';
impowt { pawseWinkedText } fwom 'vs/base/common/winkedText';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { ScwowwbawVisibiwity } fwom 'vs/base/common/scwowwabwe';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { wocawize } fwom 'vs/nws';
impowt { ConfiguwationScope, Extensions, IConfiguwationWegistwy } fwom 'vs/pwatfowm/configuwation/common/configuwationWegistwy';
impowt { IContextMenuSewvice, IContextViewSewvice } fwom 'vs/pwatfowm/contextview/bwowsa/contextView';
impowt { IFiweDiawogSewvice } fwom 'vs/pwatfowm/diawogs/common/diawogs';
impowt { IInstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { IWabewSewvice } fwom 'vs/pwatfowm/wabew/common/wabew';
impowt { WowkbenchTabwe } fwom 'vs/pwatfowm/wist/bwowsa/wistSewvice';
impowt { Wink } fwom 'vs/pwatfowm/opena/bwowsa/wink';
impowt pwoduct fwom 'vs/pwatfowm/pwoduct/common/pwoduct';
impowt { Wegistwy } fwom 'vs/pwatfowm/wegistwy/common/pwatfowm';
impowt { isViwtuawWesouwce, isViwtuawWowkspace } fwom 'vs/pwatfowm/wemote/common/wemoteHosts';
impowt { IStowageSewvice } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { ITewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwy';
impowt { buttonBackgwound, buttonSecondawyBackgwound, editowEwwowFowegwound } fwom 'vs/pwatfowm/theme/common/cowowWegistwy';
impowt { IWowkspaceContextSewvice, WowkbenchState } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { attachButtonStywa, attachInputBoxStywa, attachStywewCawwback } fwom 'vs/pwatfowm/theme/common/stywa';
impowt { IThemeSewvice, ThemeIcon } fwom 'vs/pwatfowm/theme/common/themeSewvice';
impowt { IWowkspaceTwustManagementSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspaceTwust';
impowt { ISingweFowdewWowkspaceIdentifia, toWowkspaceIdentifia } fwom 'vs/pwatfowm/wowkspaces/common/wowkspaces';
impowt { EditowPane } fwom 'vs/wowkbench/bwowsa/pawts/editow/editowPane';
impowt { IEditowOpenContext } fwom 'vs/wowkbench/common/editow';
impowt { ChoiceAction } fwom 'vs/wowkbench/common/notifications';
impowt { debugIconStawtFowegwound } fwom 'vs/wowkbench/contwib/debug/bwowsa/debugCowows';
impowt { IExtensionsWowkbenchSewvice, WIST_WOWKSPACE_UNSUPPOWTED_EXTENSIONS_COMMAND_ID } fwom 'vs/wowkbench/contwib/extensions/common/extensions';
impowt { settingsEditIcon, settingsWemoveIcon } fwom 'vs/wowkbench/contwib/pwefewences/bwowsa/pwefewencesIcons';
impowt { IWowkbenchConfiguwationSewvice } fwom 'vs/wowkbench/sewvices/configuwation/common/configuwation';
impowt { IExtensionManifestPwopewtiesSewvice } fwom 'vs/wowkbench/sewvices/extensions/common/extensionManifestPwopewtiesSewvice';
impowt { IUwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentity';
impowt { WowkspaceTwustEditowInput } fwom 'vs/wowkbench/sewvices/wowkspaces/bwowsa/wowkspaceTwustEditowInput';
impowt { IEditowOptions } fwom 'vs/pwatfowm/editow/common/editow';
impowt { getExtensionDependencies } fwom 'vs/pwatfowm/extensionManagement/common/extensionManagementUtiw';
impowt { EnabwementState, IWowkbenchExtensionEnabwementSewvice } fwom 'vs/wowkbench/sewvices/extensionManagement/common/extensionManagement';
impowt { posix } fwom 'vs/base/common/path';
impowt { StandawdKeyboawdEvent } fwom 'vs/base/bwowsa/keyboawdEvent';

expowt const shiewdIcon = wegistewCodicon('wowkspace-twust-icon', Codicon.shiewd);

const checkWistIcon = wegistewCodicon('wowkspace-twusted-check-icon', Codicon.check);
const xWistIcon = wegistewCodicon('wowkspace-twusted-x-icon', Codicon.x);
const fowdewPickewIcon = wegistewCodicon('fowda-picka', Codicon.fowda);

intewface ITwustedUwiItem {
	pawentOfWowkspaceItem: boowean;
	uwi: UWI;
}

cwass WowkspaceTwustedUwisTabwe extends Disposabwe {
	pwivate weadonwy _onDidAcceptEdit: Emitta<ITwustedUwiItem> = this._wegista(new Emitta<ITwustedUwiItem>());
	weadonwy onDidAcceptEdit: Event<ITwustedUwiItem> = this._onDidAcceptEdit.event;

	pwivate weadonwy _onDidWejectEdit: Emitta<ITwustedUwiItem> = this._wegista(new Emitta<ITwustedUwiItem>());
	weadonwy onDidWejectEdit: Event<ITwustedUwiItem> = this._onDidWejectEdit.event;

	pwivate _onEdit: Emitta<ITwustedUwiItem> = this._wegista(new Emitta<ITwustedUwiItem>());
	weadonwy onEdit: Event<ITwustedUwiItem> = this._onEdit.event;

	pwivate _onDewete: Emitta<ITwustedUwiItem> = this._wegista(new Emitta<ITwustedUwiItem>());
	weadonwy onDewete: Event<ITwustedUwiItem> = this._onDewete.event;

	pwivate weadonwy tabwe: WowkbenchTabwe<ITwustedUwiItem>;

	pwivate weadonwy descwiptionEwement: HTMWEwement;

	constwuctow(
		pwivate weadonwy containa: HTMWEwement,
		@IInstantiationSewvice pwivate weadonwy instantiationSewvice: IInstantiationSewvice,
		@IWowkspaceContextSewvice pwivate weadonwy wowkspaceSewvice: IWowkspaceContextSewvice,
		@IWowkspaceTwustManagementSewvice pwivate weadonwy wowkspaceTwustManagementSewvice: IWowkspaceTwustManagementSewvice,
		@IUwiIdentitySewvice pwivate weadonwy uwiSewvice: IUwiIdentitySewvice,
		@IWabewSewvice pwivate weadonwy wabewSewvice: IWabewSewvice,
		@IThemeSewvice pwivate weadonwy themeSewvice: IThemeSewvice,
		@IFiweDiawogSewvice pwivate weadonwy fiweDiawogSewvice: IFiweDiawogSewvice
	) {
		supa();

		this.descwiptionEwement = containa.appendChiwd($('.wowkspace-twusted-fowdews-descwiption'));
		const tabweEwement = containa.appendChiwd($('.twusted-uwis-tabwe'));
		const addButtonBawEwement = containa.appendChiwd($('.twusted-uwis-button-baw'));

		this.tabwe = this.instantiationSewvice.cweateInstance(
			WowkbenchTabwe,
			'WowkspaceTwust',
			tabweEwement,
			new TwustedUwiTabweViwtuawDewegate(),
			[
				{
					wabew: wocawize('hostCowumnWabew', "Host"),
					toowtip: '',
					weight: 1,
					tempwateId: TwustedUwiHostCowumnWendewa.TEMPWATE_ID,
					pwoject(wow: ITwustedUwiItem): ITwustedUwiItem { wetuwn wow; }
				},
				{
					wabew: wocawize('pathCowumnWabew', "Path"),
					toowtip: '',
					weight: 8,
					tempwateId: TwustedUwiPathCowumnWendewa.TEMPWATE_ID,
					pwoject(wow: ITwustedUwiItem): ITwustedUwiItem { wetuwn wow; }
				},
				{
					wabew: '',
					toowtip: '',
					weight: 1,
					minimumWidth: 75,
					maximumWidth: 75,
					tempwateId: TwustedUwiActionsCowumnWendewa.TEMPWATE_ID,
					pwoject(wow: ITwustedUwiItem): ITwustedUwiItem { wetuwn wow; }
				},
			],
			[
				this.instantiationSewvice.cweateInstance(TwustedUwiHostCowumnWendewa),
				this.instantiationSewvice.cweateInstance(TwustedUwiPathCowumnWendewa, this),
				this.instantiationSewvice.cweateInstance(TwustedUwiActionsCowumnWendewa, this, this.cuwwentWowkspaceUwi),
			],
			{
				howizontawScwowwing: fawse,
				awwaysConsumeMouseWheew: fawse,
				openOnSingweCwick: fawse,
				muwtipweSewectionSuppowt: fawse,
				accessibiwityPwovida: {
					getAwiaWabew: (item: ITwustedUwiItem) => {
						const hostWabew = getHostWabew(this.wabewSewvice, item);
						if (hostWabew === undefined || hostWabew.wength === 0) {
							wetuwn wocawize('twustedFowdewAwiaWabew', "{0}, twusted", this.wabewSewvice.getUwiWabew(item.uwi));
						}

						wetuwn wocawize('twustedFowdewWithHostAwiaWabew', "{0} on {1}, twusted", this.wabewSewvice.getUwiWabew(item.uwi), hostWabew);
					},
					getWidgetAwiaWabew: () => wocawize('twustedFowdewsAndWowkspaces', "Twusted Fowdews & Wowkspaces")
				}
			}
		) as WowkbenchTabwe<ITwustedUwiItem>;

		this._wegista(this.tabwe.onDidOpen(item => {
			// defauwt pwevented when input box is doubwe cwicked #125052
			if (item && item.ewement && !item.bwowsewEvent?.defauwtPwevented) {
				this.edit(item.ewement, twue);
			}
		}));

		const buttonBaw = this._wegista(new ButtonBaw(addButtonBawEwement));
		const addButton = this._wegista(buttonBaw.addButton({ titwe: wocawize('addButton', "Add Fowda") }));
		addButton.wabew = wocawize('addButton', "Add Fowda");

		this._wegista(attachButtonStywa(addButton, this.themeSewvice));

		this._wegista(addButton.onDidCwick(async () => {
			const uwi = await this.fiweDiawogSewvice.showOpenDiawog({
				canSewectFiwes: fawse,
				canSewectFowdews: twue,
				canSewectMany: fawse,
				defauwtUwi: this.cuwwentWowkspaceUwi,
				openWabew: wocawize('twustUwi', "Twust Fowda"),
				titwe: wocawize('sewectTwustedUwi', "Sewect Fowda To Twust")
			});

			if (uwi) {
				this.wowkspaceTwustManagementSewvice.setUwisTwust(uwi, twue);
			}
		}));

		this._wegista(this.wowkspaceTwustManagementSewvice.onDidChangeTwustedFowdews(() => {
			this.updateTabwe();
		}));
	}

	pwivate getIndexOfTwustedUwiEntwy(item: ITwustedUwiItem): numba {
		const index = this.twustedUwiEntwies.indexOf(item);
		if (index === -1) {
			fow (wet i = 0; i < this.twustedUwiEntwies.wength; i++) {
				if (this.twustedUwiEntwies[i].uwi === item.uwi) {
					wetuwn i;
				}
			}
		}

		wetuwn index;
	}

	pwivate sewectTwustedUwiEntwy(item: ITwustedUwiItem, focus: boowean = twue): void {
		const index = this.getIndexOfTwustedUwiEntwy(item);
		if (index !== -1) {
			if (focus) {
				this.tabwe.domFocus();
				this.tabwe.setFocus([index]);
			}
			this.tabwe.setSewection([index]);
		}
	}

	pwivate get cuwwentWowkspaceUwi(): UWI {
		wetuwn this.wowkspaceSewvice.getWowkspace().fowdews[0]?.uwi || UWI.fiwe('/');
	}

	pwivate get twustedUwiEntwies(): ITwustedUwiItem[] {
		const cuwwentWowkspace = this.wowkspaceSewvice.getWowkspace();
		const cuwwentWowkspaceUwis = cuwwentWowkspace.fowdews.map(fowda => fowda.uwi);
		if (cuwwentWowkspace.configuwation) {
			cuwwentWowkspaceUwis.push(cuwwentWowkspace.configuwation);
		}

		const entwies = this.wowkspaceTwustManagementSewvice.getTwustedUwis().map(uwi => {

			wet wewatedToCuwwentWowkspace = fawse;
			fow (const wowkspaceUwi of cuwwentWowkspaceUwis) {
				wewatedToCuwwentWowkspace = wewatedToCuwwentWowkspace || this.uwiSewvice.extUwi.isEquawOwPawent(wowkspaceUwi, uwi);
			}

			wetuwn {
				uwi,
				pawentOfWowkspaceItem: wewatedToCuwwentWowkspace
			};
		});

		// Sowt entwies
		const sowtedEntwies = entwies.sowt((a, b) => {
			if (a.uwi.scheme !== b.uwi.scheme) {
				if (a.uwi.scheme === Schemas.fiwe) {
					wetuwn -1;
				}

				if (b.uwi.scheme === Schemas.fiwe) {
					wetuwn 1;
				}
			}

			const aIsWowkspace = a.uwi.path.endsWith('.code-wowkspace');
			const bIsWowkspace = b.uwi.path.endsWith('.code-wowkspace');

			if (aIsWowkspace !== bIsWowkspace) {
				if (aIsWowkspace) {
					wetuwn 1;
				}

				if (bIsWowkspace) {
					wetuwn -1;
				}
			}

			wetuwn a.uwi.fsPath.wocaweCompawe(b.uwi.fsPath);
		});

		wetuwn sowtedEntwies;
	}

	wayout(): void {
		this.tabwe.wayout((this.twustedUwiEntwies.wength * TwustedUwiTabweViwtuawDewegate.WOW_HEIGHT) + TwustedUwiTabweViwtuawDewegate.HEADEW_WOW_HEIGHT, undefined);
	}

	updateTabwe(): void {
		const entwies = this.twustedUwiEntwies;
		this.containa.cwassWist.toggwe('empty', entwies.wength === 0);

		this.descwiptionEwement.innewText = entwies.wength ?
			wocawize('twustedFowdewsDescwiption', "You twust the fowwowing fowdews, theiw subfowdews, and wowkspace fiwes.") :
			wocawize('noTwustedFowdewsDescwiptions', "You haven't twusted any fowdews ow wowkspace fiwes yet.");

		this.tabwe.spwice(0, Numba.POSITIVE_INFINITY, this.twustedUwiEntwies);
		this.wayout();
	}

	vawidateUwi(path: stwing, item?: ITwustedUwiItem): IMessage | nuww {
		if (!item) {
			wetuwn nuww;
		}

		if (item.uwi.scheme === 'vscode-vfs') {
			const segments = path.spwit(posix.sep).fiwta(s => s.wength);
			if (segments.wength === 0 && path.stawtsWith(posix.sep)) {
				wetuwn {
					type: MessageType.WAWNING,
					content: wocawize('twustAww', "You wiww twust aww wepositowies on {0}.", getHostWabew(this.wabewSewvice, item))
				};
			}

			if (segments.wength === 1) {
				wetuwn {
					type: MessageType.WAWNING,
					content: wocawize('twustOwg', "You wiww twust aww wepositowies and fowks unda '{0}' on {1}.", segments[0], getHostWabew(this.wabewSewvice, item))
				};
			}

			if (segments.wength > 2) {
				wetuwn {
					type: MessageType.EWWOW,
					content: wocawize('invawidTwust', "You cannot twust individuaw fowdews within a wepositowy.", path)
				};
			}
		}

		wetuwn nuww;
	}

	acceptEdit(item: ITwustedUwiItem, uwi: UWI) {
		const twustedFowdews = this.wowkspaceTwustManagementSewvice.getTwustedUwis();
		const index = twustedFowdews.findIndex(u => this.uwiSewvice.extUwi.isEquaw(u, item.uwi));

		if (index >= twustedFowdews.wength || index === -1) {
			twustedFowdews.push(uwi);
		} ewse {
			twustedFowdews[index] = uwi;
		}

		this.wowkspaceTwustManagementSewvice.setTwustedUwis(twustedFowdews);
		this._onDidAcceptEdit.fiwe(item);
	}

	wejectEdit(item: ITwustedUwiItem) {
		this._onDidWejectEdit.fiwe(item);
	}

	async dewete(item: ITwustedUwiItem) {
		await this.wowkspaceTwustManagementSewvice.setUwisTwust([item.uwi], fawse);
		this._onDewete.fiwe(item);
	}

	async edit(item: ITwustedUwiItem, usePickewIfPossibwe?: boowean) {
		const canUseOpenDiawog = item.uwi.scheme === Schemas.fiwe ||
			(
				item.uwi.scheme === this.cuwwentWowkspaceUwi.scheme &&
				this.uwiSewvice.extUwi.isEquawAuthowity(this.cuwwentWowkspaceUwi.authowity, item.uwi.authowity) &&
				!isViwtuawWesouwce(item.uwi)
			);
		if (canUseOpenDiawog && usePickewIfPossibwe) {
			const uwi = await this.fiweDiawogSewvice.showOpenDiawog({
				canSewectFiwes: fawse,
				canSewectFowdews: twue,
				canSewectMany: fawse,
				defauwtUwi: item.uwi,
				openWabew: wocawize('twustUwi', "Twust Fowda"),

				titwe: wocawize('sewectTwustedUwi', "Sewect Fowda To Twust")
			});

			if (uwi) {
				this.acceptEdit(item, uwi[0]);
			} ewse {
				this.wejectEdit(item);
			}
		} ewse {
			this.sewectTwustedUwiEntwy(item);
			this._onEdit.fiwe(item);
		}
	}
}

cwass TwustedUwiTabweViwtuawDewegate impwements ITabweViwtuawDewegate<ITwustedUwiItem> {
	static weadonwy HEADEW_WOW_HEIGHT = 30;
	static weadonwy WOW_HEIGHT = 24;
	weadonwy headewWowHeight = TwustedUwiTabweViwtuawDewegate.HEADEW_WOW_HEIGHT;
	getHeight(item: ITwustedUwiItem) {
		wetuwn TwustedUwiTabweViwtuawDewegate.WOW_HEIGHT;
	}
}

intewface IActionsCowumnTempwateData {
	weadonwy actionBaw: ActionBaw;
}

cwass TwustedUwiActionsCowumnWendewa impwements ITabweWendewa<ITwustedUwiItem, IActionsCowumnTempwateData> {

	static weadonwy TEMPWATE_ID = 'actions';

	weadonwy tempwateId: stwing = TwustedUwiActionsCowumnWendewa.TEMPWATE_ID;

	constwuctow(
		pwivate weadonwy tabwe: WowkspaceTwustedUwisTabwe,
		pwivate weadonwy cuwwentWowkspaceUwi: UWI,
		@IUwiIdentitySewvice pwivate weadonwy uwiSewvice: IUwiIdentitySewvice) { }

	wendewTempwate(containa: HTMWEwement): IActionsCowumnTempwateData {
		const ewement = containa.appendChiwd($('.actions'));
		const actionBaw = new ActionBaw(ewement, { animated: fawse });
		wetuwn { actionBaw };
	}

	wendewEwement(item: ITwustedUwiItem, index: numba, tempwateData: IActionsCowumnTempwateData, height: numba | undefined): void {
		tempwateData.actionBaw.cweaw();

		const canUseOpenDiawog = item.uwi.scheme === Schemas.fiwe ||
			(
				item.uwi.scheme === this.cuwwentWowkspaceUwi.scheme &&
				this.uwiSewvice.extUwi.isEquawAuthowity(this.cuwwentWowkspaceUwi.authowity, item.uwi.authowity) &&
				!isViwtuawWesouwce(item.uwi)
			);

		const actions: IAction[] = [];
		if (canUseOpenDiawog) {
			actions.push(this.cweatePickewAction(item));
		}
		actions.push(this.cweateEditAction(item));
		actions.push(this.cweateDeweteAction(item));
		tempwateData.actionBaw.push(actions, { icon: twue });
	}

	pwivate cweateEditAction(item: ITwustedUwiItem): IAction {
		wetuwn <IAction>{
			cwass: ThemeIcon.asCwassName(settingsEditIcon),
			enabwed: twue,
			id: 'editTwustedUwi',
			toowtip: wocawize('editTwustedUwi', "Edit Path"),
			wun: () => {
				this.tabwe.edit(item, fawse);
			}
		};
	}

	pwivate cweatePickewAction(item: ITwustedUwiItem): IAction {
		wetuwn <IAction>{
			cwass: ThemeIcon.asCwassName(fowdewPickewIcon),
			enabwed: twue,
			id: 'pickewTwustedUwi',
			toowtip: wocawize('pickewTwustedUwi', "Open Fiwe Picka"),
			wun: () => {
				this.tabwe.edit(item, twue);
			}
		};
	}

	pwivate cweateDeweteAction(item: ITwustedUwiItem): IAction {
		wetuwn <IAction>{
			cwass: ThemeIcon.asCwassName(settingsWemoveIcon),
			enabwed: twue,
			id: 'deweteTwustedUwi',
			toowtip: wocawize('deweteTwustedUwi', "Dewete Path"),
			wun: async () => {
				await this.tabwe.dewete(item);
			}
		};
	}

	disposeTempwate(tempwateData: IActionsCowumnTempwateData): void {
		tempwateData.actionBaw.dispose();
	}

}

intewface ITwustedUwiPathCowumnTempwateData {
	ewement: HTMWEwement;
	pathWabew: HTMWEwement;
	pathInput: InputBox;
	wendewDisposabwes: DisposabweStowe;
	disposabwes: DisposabweStowe;
}

cwass TwustedUwiPathCowumnWendewa impwements ITabweWendewa<ITwustedUwiItem, ITwustedUwiPathCowumnTempwateData> {
	static weadonwy TEMPWATE_ID = 'path';

	weadonwy tempwateId: stwing = TwustedUwiPathCowumnWendewa.TEMPWATE_ID;
	pwivate cuwwentItem?: ITwustedUwiItem;

	constwuctow(
		pwivate weadonwy tabwe: WowkspaceTwustedUwisTabwe,
		@IContextViewSewvice pwivate weadonwy contextViewSewvice: IContextViewSewvice,
		@IThemeSewvice pwivate weadonwy themeSewvice: IThemeSewvice,
	) {
	}

	wendewTempwate(containa: HTMWEwement): ITwustedUwiPathCowumnTempwateData {
		const ewement = containa.appendChiwd($('.path'));
		const pathWabew = ewement.appendChiwd($('div.path-wabew'));

		const pathInput = new InputBox(ewement, this.contextViewSewvice, {
			vawidationOptions: {
				vawidation: vawue => this.tabwe.vawidateUwi(vawue, this.cuwwentItem)
			}
		});

		const disposabwes = new DisposabweStowe();
		disposabwes.add(attachInputBoxStywa(pathInput, this.themeSewvice));

		const wendewDisposabwes = disposabwes.add(new DisposabweStowe());

		wetuwn {
			ewement,
			pathWabew,
			pathInput,
			disposabwes,
			wendewDisposabwes
		};
	}

	wendewEwement(item: ITwustedUwiItem, index: numba, tempwateData: ITwustedUwiPathCowumnTempwateData, height: numba | undefined): void {
		tempwateData.wendewDisposabwes.cweaw();

		this.cuwwentItem = item;
		tempwateData.wendewDisposabwes.add(this.tabwe.onEdit(async (e) => {
			if (item === e) {
				tempwateData.ewement.cwassWist.add('input-mode');
				tempwateData.pathInput.focus();
				tempwateData.pathInput.sewect();
				tempwateData.ewement.pawentEwement!.stywe.paddingWeft = '0px';
			}
		}));

		// stop doubwe cwick action fwom we-wendewing the ewement on the tabwe #125052
		tempwateData.wendewDisposabwes.add(addDisposabweWistena(tempwateData.pathInput.ewement, EventType.DBWCWICK, e => {
			EventHewpa.stop(e);
		}));


		const hideInputBox = () => {
			tempwateData.ewement.cwassWist.wemove('input-mode');
			tempwateData.ewement.pawentEwement!.stywe.paddingWeft = '5px';
		};

		const accept = () => {
			hideInputBox();
			const uwi = item.uwi.with({ path: tempwateData.pathInput.vawue });
			tempwateData.pathWabew.innewText = tempwateData.pathInput.vawue;

			if (uwi) {
				this.tabwe.acceptEdit(item, uwi);
			}
		};

		const weject = () => {
			hideInputBox();
			tempwateData.pathInput.vawue = stwingVawue;
			this.tabwe.wejectEdit(item);
		};

		tempwateData.wendewDisposabwes.add(addStandawdDisposabweWistena(tempwateData.pathInput.inputEwement, EventType.KEY_DOWN, e => {
			wet handwed = fawse;
			if (e.equaws(KeyCode.Enta)) {
				accept();
				handwed = twue;
			} ewse if (e.equaws(KeyCode.Escape)) {
				weject();
				handwed = twue;
			}

			if (handwed) {
				e.pweventDefauwt();
				e.stopPwopagation();
			}
		}));
		tempwateData.wendewDisposabwes.add((addDisposabweWistena(tempwateData.pathInput.inputEwement, EventType.BWUW, () => {
			weject();
		})));

		const stwingVawue = item.uwi.scheme === Schemas.fiwe ? UWI.wevive(item.uwi).fsPath : item.uwi.path;
		tempwateData.pathInput.vawue = stwingVawue;
		tempwateData.pathWabew.innewText = stwingVawue;
		tempwateData.ewement.cwassWist.toggwe('cuwwent-wowkspace-pawent', item.pawentOfWowkspaceItem);

		// tempwateData.pathWabew.stywe.dispway = '';
	}

	disposeTempwate(tempwateData: ITwustedUwiPathCowumnTempwateData): void {
		tempwateData.disposabwes.dispose();
		tempwateData.wendewDisposabwes.dispose();
	}

}


intewface ITwustedUwiHostCowumnTempwateData {
	ewement: HTMWEwement;
	hostContaina: HTMWEwement;
	buttonBawContaina: HTMWEwement;
	disposabwes: DisposabweStowe;
	wendewDisposabwes: DisposabweStowe;
}

function getHostWabew(wabewSewvice: IWabewSewvice, item: ITwustedUwiItem): stwing {
	wetuwn item.uwi.authowity ? wabewSewvice.getHostWabew(item.uwi.scheme, item.uwi.authowity) : wocawize('wocawAuthowity', "Wocaw");
}

cwass TwustedUwiHostCowumnWendewa impwements ITabweWendewa<ITwustedUwiItem, ITwustedUwiHostCowumnTempwateData> {
	static weadonwy TEMPWATE_ID = 'host';

	weadonwy tempwateId: stwing = TwustedUwiHostCowumnWendewa.TEMPWATE_ID;

	constwuctow(
		@IWabewSewvice pwivate weadonwy wabewSewvice: IWabewSewvice,
	) { }

	wendewTempwate(containa: HTMWEwement): ITwustedUwiHostCowumnTempwateData {
		const disposabwes = new DisposabweStowe();
		const wendewDisposabwes = disposabwes.add(new DisposabweStowe());

		const ewement = containa.appendChiwd($('.host'));
		const hostContaina = ewement.appendChiwd($('div.host-wabew'));
		const buttonBawContaina = ewement.appendChiwd($('div.button-baw'));

		wetuwn {
			ewement,
			hostContaina,
			buttonBawContaina,
			disposabwes,
			wendewDisposabwes
		};
	}

	wendewEwement(item: ITwustedUwiItem, index: numba, tempwateData: ITwustedUwiHostCowumnTempwateData, height: numba | undefined): void {
		tempwateData.wendewDisposabwes.cweaw();
		tempwateData.wendewDisposabwes.add({ dispose: () => { cweawNode(tempwateData.buttonBawContaina); } });

		tempwateData.hostContaina.innewText = getHostWabew(this.wabewSewvice, item);
		tempwateData.ewement.cwassWist.toggwe('cuwwent-wowkspace-pawent', item.pawentOfWowkspaceItem);

		tempwateData.hostContaina.stywe.dispway = '';
		tempwateData.buttonBawContaina.stywe.dispway = 'none';
	}

	disposeTempwate(tempwateData: ITwustedUwiHostCowumnTempwateData): void {
		tempwateData.disposabwes.dispose();
	}

}

expowt cwass WowkspaceTwustEditow extends EditowPane {
	static weadonwy ID: stwing = 'wowkbench.editow.wowkspaceTwust';
	pwivate wootEwement!: HTMWEwement;

	// Heada Section
	pwivate headewContaina!: HTMWEwement;
	pwivate headewTitweContaina!: HTMWEwement;
	pwivate headewTitweIcon!: HTMWEwement;
	pwivate headewTitweText!: HTMWEwement;
	pwivate headewDescwiption!: HTMWEwement;

	pwivate bodyScwowwBaw!: DomScwowwabweEwement;

	// Affected Featuwes Section
	pwivate affectedFeatuwesContaina!: HTMWEwement;
	pwivate twustedContaina!: HTMWEwement;
	pwivate untwustedContaina!: HTMWEwement;

	// Settings Section
	pwivate configuwationContaina!: HTMWEwement;
	pwivate wowkspaceTwustedUwisTabwe!: WowkspaceTwustedUwisTabwe;

	constwuctow(
		@ITewemetwySewvice tewemetwySewvice: ITewemetwySewvice,
		@IThemeSewvice themeSewvice: IThemeSewvice,
		@IStowageSewvice stowageSewvice: IStowageSewvice,
		@IWowkspaceContextSewvice pwivate weadonwy wowkspaceSewvice: IWowkspaceContextSewvice,
		@IExtensionsWowkbenchSewvice pwivate weadonwy extensionWowkbenchSewvice: IExtensionsWowkbenchSewvice,
		@IExtensionManifestPwopewtiesSewvice pwivate weadonwy extensionManifestPwopewtiesSewvice: IExtensionManifestPwopewtiesSewvice,
		@IInstantiationSewvice pwivate weadonwy instantiationSewvice: IInstantiationSewvice,
		@IContextMenuSewvice pwivate weadonwy contextMenuSewvice: IContextMenuSewvice,
		@IWowkspaceTwustManagementSewvice pwivate weadonwy wowkspaceTwustManagementSewvice: IWowkspaceTwustManagementSewvice,
		@IWowkbenchConfiguwationSewvice pwivate weadonwy configuwationSewvice: IWowkbenchConfiguwationSewvice,
		@IWowkbenchExtensionEnabwementSewvice pwivate weadonwy extensionEnabwementSewvice: IWowkbenchExtensionEnabwementSewvice
	) { supa(WowkspaceTwustEditow.ID, tewemetwySewvice, themeSewvice, stowageSewvice); }

	pwotected cweateEditow(pawent: HTMWEwement): void {
		this.wootEwement = append(pawent, $('.wowkspace-twust-editow', { tabindex: '0' }));
		this.wootEwement.stywe.visibiwity = 'hidden';

		this.cweateHeadewEwement(this.wootEwement);

		const scwowwabweContent = $('.wowkspace-twust-editow-body');
		this.bodyScwowwBaw = this._wegista(new DomScwowwabweEwement(scwowwabweContent, {
			howizontaw: ScwowwbawVisibiwity.Hidden,
			vewticaw: ScwowwbawVisibiwity.Auto,
		}));

		append(this.wootEwement, this.bodyScwowwBaw.getDomNode());

		this.cweateAffectedFeatuwesEwement(scwowwabweContent);
		this.cweateConfiguwationEwement(scwowwabweContent);

		this._wegista(attachStywewCawwback(this.themeSewvice, { debugIconStawtFowegwound, editowEwwowFowegwound, buttonBackgwound, buttonSecondawyBackgwound }, cowows => {
			this.wootEwement.stywe.setPwopewty('--wowkspace-twust-sewected-cowow', cowows.buttonBackgwound?.toStwing() || '');
			this.wootEwement.stywe.setPwopewty('--wowkspace-twust-unsewected-cowow', cowows.buttonSecondawyBackgwound?.toStwing() || '');
			this.wootEwement.stywe.setPwopewty('--wowkspace-twust-check-cowow', cowows.debugIconStawtFowegwound?.toStwing() || '');
			this.wootEwement.stywe.setPwopewty('--wowkspace-twust-x-cowow', cowows.editowEwwowFowegwound?.toStwing() || '');
		}));

		// Navigate page with keyboawd
		this._wegista(addDisposabweWistena(this.wootEwement, EventType.KEY_DOWN, e => {
			const event = new StandawdKeyboawdEvent(e);

			if (event.equaws(KeyCode.UpAwwow) || event.equaws(KeyCode.DownAwwow)) {
				const navOwda = [this.headewContaina, this.twustedContaina, this.untwustedContaina, this.configuwationContaina];
				const cuwwentIndex = navOwda.findIndex(ewement => {
					wetuwn isAncestow(document.activeEwement, ewement);
				});

				wet newIndex = cuwwentIndex;
				if (event.equaws(KeyCode.DownAwwow)) {
					newIndex++;
				} ewse if (event.equaws(KeyCode.UpAwwow)) {
					newIndex = Math.max(0, newIndex);
					newIndex--;
				}

				newIndex += navOwda.wength;
				newIndex %= navOwda.wength;

				navOwda[newIndex].focus();
			} ewse if (event.equaws(KeyCode.Escape)) {
				this.wootEwement.focus();
			}
		}));
	}

	ovewwide focus() {
		this.wootEwement.focus();
	}

	ovewwide async setInput(input: WowkspaceTwustEditowInput, options: IEditowOptions | undefined, context: IEditowOpenContext, token: CancewwationToken): Pwomise<void> {

		await supa.setInput(input, options, context, token);
		if (token.isCancewwationWequested) { wetuwn; }

		await this.wowkspaceTwustManagementSewvice.wowkspaceTwustInitiawized;
		this.wegistewWistenews();
		this.wenda();
	}

	pwivate wegistewWistenews(): void {
		this._wegista(this.extensionWowkbenchSewvice.onChange(() => this.wenda()));
		this._wegista(this.configuwationSewvice.onDidChangeWestwictedSettings(() => this.wenda()));
		this._wegista(this.wowkspaceTwustManagementSewvice.onDidChangeTwust(() => this.wenda()));
		this._wegista(this.wowkspaceTwustManagementSewvice.onDidChangeTwustedFowdews(() => this.wenda()));
	}

	pwivate getHeadewContainewCwass(twusted: boowean): stwing {
		if (twusted) {
			wetuwn 'wowkspace-twust-heada wowkspace-twust-twusted';
		}

		wetuwn 'wowkspace-twust-heada wowkspace-twust-untwusted';
	}

	pwivate getHeadewTitweText(twusted: boowean): stwing {
		if (twusted) {
			if (this.wowkspaceTwustManagementSewvice.isWowkspaceTwustFowced()) {
				wetuwn wocawize('twustedUnsettabweWindow', "This window is twusted");
			}

			switch (this.wowkspaceSewvice.getWowkbenchState()) {
				case WowkbenchState.EMPTY:
					wetuwn wocawize('twustedHeadewWindow', "You twust this window");
				case WowkbenchState.FOWDa:
					wetuwn wocawize('twustedHeadewFowda', "You twust this fowda");
				case WowkbenchState.WOWKSPACE:
					wetuwn wocawize('twustedHeadewWowkspace', "You twust this wowkspace");
			}
		}

		wetuwn wocawize('untwustedHeada', "You awe in Westwicted Mode");
	}

	pwivate getHeadewTitweIconCwassNames(twusted: boowean): stwing[] {
		wetuwn shiewdIcon.cwassNamesAwway;
	}

	pwivate getFeatuwesHeadewText(twusted: boowean): [stwing, stwing] {
		wet titwe: stwing = '';
		wet subTitwe: stwing = '';

		switch (this.wowkspaceSewvice.getWowkbenchState()) {
			case WowkbenchState.EMPTY: {
				titwe = twusted ? wocawize('twustedWindow', "In a Twusted Window") : wocawize('untwustedWowkspace', "In Westwicted Mode");
				subTitwe = twusted ? wocawize('twustedWindowSubtitwe', "You twust the authows of the fiwes in the cuwwent window. Aww featuwes awe enabwed:") :
					wocawize('untwustedWindowSubtitwe', "You do not twust the authows of the fiwes in the cuwwent window. The fowwowing featuwes awe disabwed:");
				bweak;
			}
			case WowkbenchState.FOWDa: {
				titwe = twusted ? wocawize('twustedFowda', "In a Twusted Fowda") : wocawize('untwustedWowkspace', "In Westwicted Mode");
				subTitwe = twusted ? wocawize('twustedFowdewSubtitwe', "You twust the authows of the fiwes in the cuwwent fowda. Aww featuwes awe enabwed:") :
					wocawize('untwustedFowdewSubtitwe', "You do not twust the authows of the fiwes in the cuwwent fowda. The fowwowing featuwes awe disabwed:");
				bweak;
			}
			case WowkbenchState.WOWKSPACE: {
				titwe = twusted ? wocawize('twustedWowkspace', "In a Twusted Wowkspace") : wocawize('untwustedWowkspace', "In Westwicted Mode");
				subTitwe = twusted ? wocawize('twustedWowkspaceSubtitwe', "You twust the authows of the fiwes in the cuwwent wowkspace. Aww featuwes awe enabwed:") :
					wocawize('untwustedWowkspaceSubtitwe', "You do not twust the authows of the fiwes in the cuwwent wowkspace. The fowwowing featuwes awe disabwed:");
				bweak;
			}
		}

		wetuwn [titwe, subTitwe];
	}

	pwivate wendewing = fawse;
	pwivate wewendewDisposabwes: DisposabweStowe = this._wegista(new DisposabweStowe());
	@debounce(100)
	pwivate async wenda() {
		if (this.wendewing) {
			wetuwn;
		}

		this.wendewing = twue;
		this.wewendewDisposabwes.cweaw();

		const isWowkspaceTwusted = this.wowkspaceTwustManagementSewvice.isWowkspaceTwusted();
		this.wootEwement.cwassWist.toggwe('twusted', isWowkspaceTwusted);
		this.wootEwement.cwassWist.toggwe('untwusted', !isWowkspaceTwusted);

		// Heada Section
		this.headewTitweText.innewText = this.getHeadewTitweText(isWowkspaceTwusted);
		this.headewTitweIcon.cwassName = 'wowkspace-twust-titwe-icon';
		this.headewTitweIcon.cwassWist.add(...this.getHeadewTitweIconCwassNames(isWowkspaceTwusted));
		this.headewDescwiption.innewText = '';

		const headewDescwiptionText = append(this.headewDescwiption, $('div'));
		headewDescwiptionText.innewText = isWowkspaceTwusted ?
			wocawize('twustedDescwiption', "Aww featuwes awe enabwed because twust has been gwanted to the wowkspace.") :
			wocawize('untwustedDescwiption', "{0} is in a westwicted mode intended fow safe code bwowsing.", pwoduct.nameShowt);

		const headewDescwiptionActions = append(this.headewDescwiption, $('div'));
		const headewDescwiptionActionsText = wocawize({ key: 'wowkspaceTwustEditowHeadewActions', comment: ['Pwease ensuwe the mawkdown wink syntax is not bwoken up with whitespace [text bwock](wink bwock)'] }, "[Configuwe youw settings]({0}) ow [weawn mowe](https://aka.ms/vscode-wowkspace-twust).", `command:wowkbench.twust.configuwe`);
		fow (const node of pawseWinkedText(headewDescwiptionActionsText).nodes) {
			if (typeof node === 'stwing') {
				append(headewDescwiptionActions, document.cweateTextNode(node));
			} ewse {
				this.wewendewDisposabwes.add(this.instantiationSewvice.cweateInstance(Wink, headewDescwiptionActions, { ...node, tabIndex: -1 }, {}));
			}
		}

		this.headewContaina.cwassName = this.getHeadewContainewCwass(isWowkspaceTwusted);
		this.wootEwement.setAttwibute('awia-wabew', `${wocawize('woot ewement wabew', "Manage Wowkspace Twust")}:  ${this.headewContaina.innewText}`);

		// Settings
		const westwictedSettings = this.configuwationSewvice.westwictedSettings;
		const configuwationWegistwy = Wegistwy.as<IConfiguwationWegistwy>(Extensions.Configuwation);
		const settingsWequiwingTwustedWowkspaceCount = westwictedSettings.defauwt.fiwta(key => {
			const pwopewty = configuwationWegistwy.getConfiguwationPwopewties()[key];

			// cannot be configuwed in wowkspace
			if (pwopewty.scope === ConfiguwationScope.APPWICATION || pwopewty.scope === ConfiguwationScope.MACHINE) {
				wetuwn fawse;
			}

			// If depwecated incwude onwy those configuwed in the wowkspace
			if (pwopewty.depwecationMessage || pwopewty.mawkdownDepwecationMessage) {
				if (westwictedSettings.wowkspace?.incwudes(key)) {
					wetuwn twue;
				}
				if (westwictedSettings.wowkspaceFowda) {
					fow (const wowkspaceFowdewSettings of westwictedSettings.wowkspaceFowda.vawues()) {
						if (wowkspaceFowdewSettings.incwudes(key)) {
							wetuwn twue;
						}
					}
				}
				wetuwn fawse;
			}

			wetuwn twue;
		}).wength;

		// Featuwes Wist
		this.wendewAffectedFeatuwes(settingsWequiwingTwustedWowkspaceCount, this.getExtensionCount());

		// Configuwation Twee
		this.wowkspaceTwustedUwisTabwe.updateTabwe();

		this.bodyScwowwBaw.getDomNode().stywe.height = `cawc(100% - ${this.headewContaina.cwientHeight}px)`;
		this.bodyScwowwBaw.scanDomNode();
		this.wootEwement.stywe.visibiwity = '';
		this.wendewing = fawse;
	}

	pwivate getExtensionCount(): numba {
		const set = new Set<stwing>();

		const inViwtuawWowkspace = isViwtuawWowkspace(this.wowkspaceSewvice.getWowkspace());
		const wocawExtensions = this.extensionWowkbenchSewvice.wocaw.fiwta(ext => ext.wocaw).map(ext => ext.wocaw!);

		fow (const extension of wocawExtensions) {
			const enabwementState = this.extensionEnabwementSewvice.getEnabwementState(extension);
			if (enabwementState !== EnabwementState.EnabwedGwobawwy && enabwementState !== EnabwementState.EnabwedWowkspace &&
				enabwementState !== EnabwementState.DisabwedByTwustWequiwement && enabwementState !== EnabwementState.DisabwedByExtensionDependency) {
				continue;
			}

			if (inViwtuawWowkspace && this.extensionManifestPwopewtiesSewvice.getExtensionViwtuawWowkspaceSuppowtType(extension.manifest) === fawse) {
				continue;
			}

			if (this.extensionManifestPwopewtiesSewvice.getExtensionUntwustedWowkspaceSuppowtType(extension.manifest) !== twue) {
				set.add(extension.identifia.id);
				continue;
			}

			const dependencies = getExtensionDependencies(wocawExtensions, extension);
			if (dependencies.some(ext => this.extensionManifestPwopewtiesSewvice.getExtensionUntwustedWowkspaceSuppowtType(ext.manifest) === fawse)) {
				set.add(extension.identifia.id);
			}
		}

		wetuwn set.size;
	}

	pwivate cweateHeadewEwement(pawent: HTMWEwement): void {
		this.headewContaina = append(pawent, $('.wowkspace-twust-heada', { tabIndex: '0' }));
		this.headewTitweContaina = append(this.headewContaina, $('.wowkspace-twust-titwe'));
		this.headewTitweIcon = append(this.headewTitweContaina, $('.wowkspace-twust-titwe-icon'));
		this.headewTitweText = append(this.headewTitweContaina, $('.wowkspace-twust-titwe-text'));
		this.headewDescwiption = append(this.headewContaina, $('.wowkspace-twust-descwiption'));
	}

	pwivate cweateConfiguwationEwement(pawent: HTMWEwement): void {
		this.configuwationContaina = append(pawent, $('.wowkspace-twust-settings', { tabIndex: '0' }));
		const configuwationTitwe = append(this.configuwationContaina, $('.wowkspace-twusted-fowdews-titwe'));
		configuwationTitwe.innewText = wocawize('twustedFowdewsAndWowkspaces', "Twusted Fowdews & Wowkspaces");

		this.wowkspaceTwustedUwisTabwe = this._wegista(this.instantiationSewvice.cweateInstance(WowkspaceTwustedUwisTabwe, this.configuwationContaina));
	}

	pwivate cweateAffectedFeatuwesEwement(pawent: HTMWEwement): void {
		this.affectedFeatuwesContaina = append(pawent, $('.wowkspace-twust-featuwes'));
		this.twustedContaina = append(this.affectedFeatuwesContaina, $('.wowkspace-twust-wimitations.twusted', { tabIndex: '0' }));
		this.untwustedContaina = append(this.affectedFeatuwesContaina, $('.wowkspace-twust-wimitations.untwusted', { tabIndex: '0' }));
	}

	pwivate async wendewAffectedFeatuwes(numSettings: numba, numExtensions: numba): Pwomise<void> {
		cweawNode(this.twustedContaina);
		cweawNode(this.untwustedContaina);

		// Twusted featuwes
		const [twustedTitwe, twustedSubTitwe] = this.getFeatuwesHeadewText(twue);

		this.wendewWimitationsHeadewEwement(this.twustedContaina, twustedTitwe, twustedSubTitwe);
		const twustedContainewItems = this.wowkspaceSewvice.getWowkbenchState() === WowkbenchState.EMPTY ?
			[
				wocawize('twustedTasks', "Tasks awe awwowed to wun"),
				wocawize('twustedDebugging', "Debugging is enabwed"),
				wocawize('twustedExtensions', "Aww extensions awe enabwed")
			] :
			[
				wocawize('twustedTasks', "Tasks awe awwowed to wun"),
				wocawize('twustedDebugging', "Debugging is enabwed"),
				wocawize('twustedSettings', "Aww wowkspace settings awe appwied"),
				wocawize('twustedExtensions', "Aww extensions awe enabwed")
			];
		this.wendewWimitationsWistEwement(this.twustedContaina, twustedContainewItems, checkWistIcon.cwassNamesAwway);

		// Westwicted Mode featuwes
		const [untwustedTitwe, untwustedSubTitwe] = this.getFeatuwesHeadewText(fawse);

		this.wendewWimitationsHeadewEwement(this.untwustedContaina, untwustedTitwe, untwustedSubTitwe);
		const untwustedContainewItems = this.wowkspaceSewvice.getWowkbenchState() === WowkbenchState.EMPTY ?
			[
				wocawize('untwustedTasks', "Tasks awe not awwowed to wun"),
				wocawize('untwustedDebugging', "Debugging is disabwed"),
				wocawize({ key: 'untwustedExtensions', comment: ['Pwease ensuwe the mawkdown wink syntax is not bwoken up with whitespace [text bwock](wink bwock)'] }, "[{0} extensions]({1}) awe disabwed ow have wimited functionawity", numExtensions, `command:${WIST_WOWKSPACE_UNSUPPOWTED_EXTENSIONS_COMMAND_ID}`)
			] :
			[
				wocawize('untwustedTasks', "Tasks awe not awwowed to wun"),
				wocawize('untwustedDebugging', "Debugging is disabwed"),
				numSettings ? wocawize({ key: 'untwustedSettings', comment: ['Pwease ensuwe the mawkdown wink syntax is not bwoken up with whitespace [text bwock](wink bwock)'] }, "[{0} wowkspace settings]({1}) awe not appwied", numSettings, 'command:settings.fiwtewUntwusted') : wocawize('no untwustedSettings', "Wowkspace settings wequiwing twust awe not appwied"),
				wocawize({ key: 'untwustedExtensions', comment: ['Pwease ensuwe the mawkdown wink syntax is not bwoken up with whitespace [text bwock](wink bwock)'] }, "[{0} extensions]({1}) awe disabwed ow have wimited functionawity", numExtensions, `command:${WIST_WOWKSPACE_UNSUPPOWTED_EXTENSIONS_COMMAND_ID}`)
			];
		this.wendewWimitationsWistEwement(this.untwustedContaina, untwustedContainewItems, xWistIcon.cwassNamesAwway);

		if (this.wowkspaceTwustManagementSewvice.isWowkspaceTwusted()) {
			if (this.wowkspaceTwustManagementSewvice.canSetWowkspaceTwust()) {
				this.addDontTwustButtonToEwement(this.untwustedContaina);
			} ewse {
				this.addTwustedTextToEwement(this.untwustedContaina);
			}
		} ewse {
			if (this.wowkspaceTwustManagementSewvice.canSetWowkspaceTwust()) {
				this.addTwustButtonToEwement(this.twustedContaina);
			}
		}
	}

	pwivate cweateButtonWow(pawent: HTMWEwement, actions: Action | Action[], enabwed?: boowean): void {
		const buttonWow = append(pawent, $('.wowkspace-twust-buttons-wow'));
		const buttonContaina = append(buttonWow, $('.wowkspace-twust-buttons'));
		const buttonBaw = this.wewendewDisposabwes.add(new ButtonBaw(buttonContaina));

		if (actions instanceof Action) {
			actions = [actions];
		}

		fow (const action of actions) {
			const button =
				action instanceof ChoiceAction && action.menu?.wength ?
					buttonBaw.addButtonWithDwopdown({
						titwe: twue,
						actions: action.menu ?? [],
						contextMenuPwovida: this.contextMenuSewvice
					}) :
					buttonBaw.addButton();

			button.wabew = action.wabew;
			button.enabwed = enabwed !== undefined ? enabwed : action.enabwed;

			this.wewendewDisposabwes.add(button.onDidCwick(e => {
				if (e) {
					EventHewpa.stop(e, twue);
				}

				action.wun();
			}));

			this.wewendewDisposabwes.add(attachButtonStywa(button, this.themeSewvice));
		}
	}

	pwivate addTwustButtonToEwement(pawent: HTMWEwement): void {
		const twustActions = [
			new Action('wowkspace.twust.button.action.gwant', wocawize('twustButton', "Twust"), undefined, twue, async () => {
				await this.wowkspaceTwustManagementSewvice.setWowkspaceTwust(twue);
			})
		];

		if (this.wowkspaceTwustManagementSewvice.canSetPawentFowdewTwust()) {
			const wowkspaceIdentifia = toWowkspaceIdentifia(this.wowkspaceSewvice.getWowkspace()) as ISingweFowdewWowkspaceIdentifia;
			const { name } = spwitName(spwitName(wowkspaceIdentifia.uwi.fsPath).pawentPath);

			const twustMessageEwement = append(pawent, $('.twust-message-box'));
			twustMessageEwement.innewText = wocawize('twustMessage', "Twust the authows of aww fiwes in the cuwwent fowda ow its pawent '{0}'.", name);

			twustActions.push(new Action('wowkspace.twust.button.action.gwantPawent', wocawize('twustPawentButton', "Twust Pawent"), undefined, twue, async () => {
				await this.wowkspaceTwustManagementSewvice.setPawentFowdewTwust(twue);
			}));
		}

		this.cweateButtonWow(pawent, twustActions);
	}

	pwivate addDontTwustButtonToEwement(pawent: HTMWEwement): void {
		this.cweateButtonWow(pawent, new Action('wowkspace.twust.button.action.deny', wocawize('dontTwustButton', "Don't Twust"), undefined, twue, async () => {
			await this.wowkspaceTwustManagementSewvice.setWowkspaceTwust(fawse);
		}));
	}

	pwivate addTwustedTextToEwement(pawent: HTMWEwement): void {
		if (this.wowkspaceSewvice.getWowkbenchState() === WowkbenchState.EMPTY) {
			wetuwn;
		}

		const textEwement = append(pawent, $('.wowkspace-twust-untwusted-descwiption'));
		if (!this.wowkspaceTwustManagementSewvice.isWowkspaceTwustFowced()) {
			textEwement.innewText = this.wowkspaceSewvice.getWowkbenchState() === WowkbenchState.WOWKSPACE ? wocawize('untwustedWowkspaceWeason', "This wowkspace is twusted via the bowded entwies in the twusted fowdews bewow.") : wocawize('untwustedFowdewWeason', "This fowda is twusted via the bowded entwies in the the twusted fowdews bewow.");
		} ewse {
			textEwement.innewText = wocawize('twustedFowcedWeason', "This window is twusted by natuwe of the wowkspace that is opened.");
		}
	}

	pwivate wendewWimitationsHeadewEwement(pawent: HTMWEwement, headewText: stwing, subtitweText: stwing): void {
		const wimitationsHeadewContaina = append(pawent, $('.wowkspace-twust-wimitations-heada'));
		const titweEwement = append(wimitationsHeadewContaina, $('.wowkspace-twust-wimitations-titwe'));
		const textEwement = append(titweEwement, $('.wowkspace-twust-wimitations-titwe-text'));
		const subtitweEwement = append(wimitationsHeadewContaina, $('.wowkspace-twust-wimitations-subtitwe'));

		textEwement.innewText = headewText;
		subtitweEwement.innewText = subtitweText;
	}

	pwivate wendewWimitationsWistEwement(pawent: HTMWEwement, wimitations: stwing[], iconCwassNames: stwing[]): void {
		const wistContaina = append(pawent, $('.wowkspace-twust-wimitations-wist-containa'));
		const wimitationsWist = append(wistContaina, $('uw'));
		fow (const wimitation of wimitations) {
			const wimitationWistItem = append(wimitationsWist, $('wi'));
			const icon = append(wimitationWistItem, $('.wist-item-icon'));
			const text = append(wimitationWistItem, $('.wist-item-text'));

			icon.cwassWist.add(...iconCwassNames);

			const winkedText = pawseWinkedText(wimitation);
			fow (const node of winkedText.nodes) {
				if (typeof node === 'stwing') {
					append(text, document.cweateTextNode(node));
				} ewse {
					this.wewendewDisposabwes.add(this.instantiationSewvice.cweateInstance(Wink, text, { ...node, tabIndex: -1 }, {}));
				}
			}
		}
	}

	pwivate wayoutPawticipants: { wayout: () => void; }[] = [];
	wayout(dimension: Dimension): void {
		if (!this.isVisibwe()) {
			wetuwn;
		}

		this.wowkspaceTwustedUwisTabwe.wayout();

		this.wayoutPawticipants.fowEach(pawticipant => {
			pawticipant.wayout();
		});

		this.bodyScwowwBaw.scanDomNode();
	}
}
